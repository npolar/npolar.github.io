var Mapsel=function(e){function t(e,t,n){if(t>n){var i=t;t=n,n=i}return Math.min(n,Math.max(t,e))}function n(e,t,i,a){var s=document.createElement(t);s.append=function(e,t,i){return n(s,e,t,i)};for(var l in i)s.setAttribute(l,i[l]);return void 0!==a&&(s.innerHTML=a),e.appendChild(s),s}e=e||{};var i=this;this.api=e.api||"google",this.background=e.background||"#e3e3e3",this.container=e.container||null,this.closeable=e.closeable===!1?!1:!0,this.element=document.createElement("div"),this.elements={},this.events={},this.font={size:"14px"},this.height=e.height||250,this.instance=Mapsel.instances++,this.language=e.language||"en",this.latitude=t("number"==typeof e.latitude?e.latitude:65,-90,90),this.longitude=t("number"==typeof e.longitude?e.longitude:0,-90,90),this.opacity=t("number"==typeof e.opacity?e.opacity:1,0,1),this.precision=t("number"==typeof e.precision?e.precision:2,0,8),this.radius=Math.max(Math.round(e.radius||0),0)||null,this.visible=e.visible===!1?!1:!0,this.width=e.width||200,this.x=e.x||0,this.y=e.y||0,this.element.append=function(e,t,a){return n(i.element,e,t,a)};for(var a=this.precision?"0.":"1",s=0;s<this.precision;++s)a+=s==this.precision-1?1:0;this.elements.titleBar=this.element.append("header"),this.elements.mapContainer=this.element.append("div",{id:"mapsel_map_"+this.instance}),this.elements.fieldset=this.element.append("fieldset"),this.closeable&&(this.elements.closeButton=this.elements.titleBar.append("a",{title:Mapsel.i18n[this.language].CLOSE},"X"),this.elements.closeButton.addEventListener("click",function(){i.hide()})),this.elements.latLabel=this.elements.fieldset.append("label",{"for":"mapsel_lat_"+this.instance},Mapsel.i18n[this.language].LATITUDE),this.elements.latInput=this.elements.fieldset.append("input",{id:"mapsel_lat_"+this.instance,type:"number",title:Mapsel.i18n[this.language].LATITUDE,min:-90,max:90,step:a,value:this.latitude}),this.elements.lngLabel=this.elements.fieldset.append("label",{"for":"mapsel_lng_"+this.instance},Mapsel.i18n[this.language].LONGITUDE),this.elements.lngInput=this.elements.fieldset.append("input",{id:"mapsel_lng_"+this.instance,type:"number",title:Mapsel.i18n[this.language].LONGITUDE,min:-180,max:180,step:a,value:this.longitude}),null!==this.radius&&(this.elements.radLabel=this.elements.fieldset.append("label",{"for":"mapsel_rad_"+this.instance},Mapsel.i18n[this.language].RADIUS),this.elements.radInput=this.elements.fieldset.append("input",{id:"mapsel_rad_"+this.instance,type:"number",title:Mapsel.i18n[this.language].RADIUS,step:1,value:this.radius})),this.element.className="mapsel",this.element.style.position=this.container?"relative":"absolute",this.element.style.background=this.background,this.element.style.fontSize=this.font.size,this.element.style.opacity=this.opacity,this.container?this.container.appendChild(this.element):document.body.appendChild(this.element),this.move(this.x,this.y),this.resize(this.width,this.height),this.visible?this.init(this.api):this.hide()};Mapsel.api={},Mapsel.instances=0,Mapsel.prototype={on:function(e,t){"function"==typeof t?this.events[e]=t:this.events[e]&&delete this.events[e]},hide:function(){this.element&&(this.element.style.display="none"),this.visible=!1},focus:function(e){if(this.elements)switch(e){case"lat":case"latitude":this.elements.latInput&&this.elements.latInput.focus();break;case"lng":case"longitude":this.elements.lngInput&&this.elements.lngInput.focus();break;case"rad":case"radius":this.elements.radInput&&this.elements.radInput.focus()}},init:function(e){var t=this;for(var n in Mapsel.api)if(e.toLowerCase()==n.toLowerCase())return this.api=new Mapsel.api[n](t),!0;return console.error("Unsupported map API: "+e),!1},move:function(e,t,n){this.element&&(this.element.style.left=(n?this.x+=e:this.x=Math.max(e,0))+"px",this.element.style.top=(n?this.y+=t:this.y=Math.max(t,0))+"px")},resize:function(e,t,n){this.width=Math.max(n?this.width+=e:e,200),this.height=Math.max(n?this.height+=t:t,200);var i=0,a=document.createElement("span"),s=["LATITUDE","LONGITUDE","RADIUS"];a.style.fontSize=this.font.size,a.style.visibility="hidden",document.body.appendChild(a);for(var l in Mapsel.i18n[this.language])-1!=s.indexOf(l)&&(a.innerHTML=Mapsel.i18n[this.language][l],i=Math.max(i,a.offsetWidth));document.body.removeChild(a);var r=Math.ceil((i+15)/this.width*100),o=r+"%",d=100-r+"%",p=this.height,u=window.getComputedStyle(this.element,null);p-=parseInt(u.borderTopWidth)+parseInt(u.borderBottomWidth),p-=parseInt(u.paddingTop)+parseInt(u.paddingBottom),p-=this.elements.titleBar.offsetHeight,p-=this.elements.fieldset.offsetHeight,this.elements.latLabel.style.width=o,this.elements.latInput.style.width=d,this.elements.lngLabel.style.width=o,this.elements.lngInput.style.width=d,null!==this.radius&&(this.elements.radLabel.style.width=o,this.elements.radInput.style.width=d),this.element.style.width=this.width+"px",this.element.style.height=this.height+"px",this.elements.mapContainer.style.height=p+"px"},show:function(){this.element&&(this.element.style.display="block","object"==typeof this.api?this.api.center(this.latitude,this.longitude):this.init(this.api)),this.visible=!0}},Mapsel.i18n={en:{CLOSE:"Click to close",LATITUDE:"Latitude",LONGITUDE:"Longitude",RADIUS:"Radius"},ja:{CLOSE:"閉じます",LATITUDE:"緯度",LONGITUDE:"経度",RADIUS:"半径"},nb:{CLOSE:"Klikk for å lukke",LATITUDE:"Breddegrad",LONGITUDE:"Lengdegrad",RADIUS:"Radius"},nn:{CLOSE:"Klikk for å stengje",LATITUDE:"Breiddegrad",LONGITUDE:"Lengdegrad",RADIUS:"Radius"},yue:{CLOSE:"點擊關閉",LATITUDE:"緯度",LONGITUDE:"經度",RADIUS:"半徑"},zh:{CLOSE:"点击关闭",LATITUDE:"纬度",LONGITUDE:"经度",RADIUS:"半径"}},function(){var e=document.head||document.getElementsByTagName("head")[0],t=document.createElement("style"),n={".mapsel":["border: 1px solid #aaa","border-radius: 5px","box-shadow: 0 0 2px 0 #aaa","box-sizing: border-box","font-family: sans-serif","font-size: 0","padding: 5px","text-align: right"],".mapsel *":["border: 0","box-sizing: border-box","font-weight: normal","line-height: normal","margin: 0","padding: 0"],".mapsel header a":["color: #aaa","cursor: pointer","display: inline-block","font-size: inherit","font-weight: bold","margin: 0 2px 5px 0","text-decoration: none","text-shadow: 0 0 2px #ccc"],".mapsel header a:hover":["text-shadow: 0 0 1px #333"],".mapsel > div":["border: 1px solid #aaa","border-radius: 5px","display: block","width: 100%"],".mapsel fieldset label":["display: inline-block","font-size: inherit","padding-right: 5px","text-align: right","width: 40%"],".mapsel fieldset input":["border: 1px solid #aaa","border-radius: 5px","box-shadow: 0 0 2px 0 #aaa inset","font-size: inherit","margin-top: 5px","padding: 2px 5px","width: 60%"]};t.type="text/css";for(var i in n){var a=i+" {";for(var s in n[i])a+=n[i][s]+";";t.appendChild(document.createTextNode(a+"}"))}e.appendChild(t)}(),function(){window.google&&window.google.maps&&(Mapsel.api.Google=function(e){var t=this;this.map=null,this.marker=null,"object"==typeof e&&(t.map=new google.maps.Map(e.elements.mapContainer,{center:{lat:e.latitude,lng:e.longitude},disableDoubleClickZoom:!0,mapTypeId:google.maps.MapTypeId.TERRAIN,streetViewControl:!1,zoom:2}),e.radius?(t.marker=new google.maps.Circle({center:t.map.getCenter(),draggable:!0,editable:!0,map:t.map,radius:e.radius}),google.maps.event.addListener(t.map,"dblclick",function(e){t.marker.setCenter(e.latLng)}),google.maps.event.addListener(t.marker,"center_changed",function(){var n=t.marker.getCenter(),i=Number(n.lat().toFixed(e.precision)),a=Number(n.lng().toFixed(e.precision));i!=e.latitude&&(e.elements.latInput.value=e.latitude=i,"function"==typeof e.events.latitude&&e.events.latitude(i)),a!=e.longitude&&(e.elements.lngInput.value=e.longitude=a,"function"==typeof e.events.longitude&&e.events.longitude(a))}),google.maps.event.addListener(t.marker,"radius_changed",function(){e.elements.radInput.value=e.radius=Math.round(t.marker.getRadius()),"function"==typeof e.events.radius&&e.events.radius(e.radius)}),e.elements.latInput.addEventListener("change",function(n){t.marker.setCenter({lat:Number(n.target.value),lng:e.longitude}),t.map.setCenter(t.marker.getCenter())}),e.elements.lngInput.addEventListener("change",function(n){t.marker.setCenter({lat:e.latitude,lng:Number(n.target.value)}),t.map.setCenter(t.marker.getCenter())}),e.elements.radInput.addEventListener("change",function(n){t.marker.setRadius(e.radius=Number(n.target.value))})):(t.marker=new google.maps.Marker({position:t.map.getCenter(),draggable:!0,map:t.map}),google.maps.event.addListener(t.map,"dblclick",function(e){t.marker.setPosition(e.latLng)}),google.maps.event.addListener(t.marker,"position_changed",function(){var n=t.marker.getPosition(),i=Number(n.lat().toFixed(e.precision)),a=Number(n.lng().toFixed(e.precision));i!=e.latitude&&(e.elements.latInput.value=e.latitude=i,"function"==typeof e.events.latitude&&e.events.latitude(i)),a!=e.longitude&&(e.elements.lngInput.value=e.longitude=a,"function"==typeof e.events.longitude&&e.events.longitude(a))}),e.elements.latInput.addEventListener("change",function(n){t.marker.setPosition({lat:Number(n.target.value),lng:e.longitude}),t.map.setCenter(t.marker.getPosition())}),e.elements.lngInput.addEventListener("change",function(n){t.marker.setPosition({lat:e.latitude,lng:Number(n.target.value)}),t.map.setCenter(t.marker.getPosition())})))},Mapsel.api.Google.prototype={center:function(e,t){this.map&&this.map.setCenter({lat:e,lng:t})}})}(),function(){window.L&&window.L.map&&(Mapsel.api.Leaflet=function(e){var t=this;this.map=null,this.marker=null,"object"==typeof e&&(t.map=L.map(e.elements.mapContainer,{center:{lat:e.latitude,lng:e.longitude},doubleClickZoom:!1,zoom:2}),L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'<a href="http://osm.org/copyright">OpenStreetMap</a>',minZoom:0,maxZoom:16}).addTo(t.map),e.radius?(t.marker=L.circle(t.map.getCenter(),e.radius).addTo(t.map),t.marker.mapselEvent={move:!1,resize:!1},t.map.on("dblclick",function(n){t.marker.setLatLng(n.latlng),e.latitude=e.elements.latInput.value=n.latlng.lat.toFixed(e.precision),e.longitude=e.elements.lngInput.value=n.latlng.lng.toFixed(e.precision)}),e.elements.latInput.addEventListener("change",function(n){t.marker.setLatLng({lat:e.latitude=Number(n.target.value),lng:e.longitude}),t.map.setView(t.marker.getLatLng())}),e.elements.lngInput.addEventListener("change",function(n){t.marker.setLatLng({lat:e.latitude,lng:e.longitude=Number(n.target.value)}),t.map.setView(t.marker.getLatLng())}),e.elements.radInput.addEventListener("change",function(n){t.marker.setRadius(e.radius=Number(n.target.value))})):(t.marker=L.marker(t.map.getCenter(),{draggable:!0}).addTo(t.map),t.map.on("dblclick",function(e){t.marker.setLatLng(e.latlng)}),t.marker.on("move",function(t){var n=t.latlng,i=Number(n.lat.toFixed(e.precision)),a=Number(n.lng.toFixed(e.precision));i!=e.latitude&&(e.elements.latInput.value=e.latitude=i,"function"==typeof e.events.latitude&&e.events.latitude(i)),a!=e.longitude&&(e.elements.lngInput.value=e.longitude=a,"function"==typeof e.events.longitude&&e.events.longitude(a))}),e.elements.latInput.addEventListener("change",function(n){t.marker.setLatLng({lat:Number(n.target.value),lng:e.longitude}),t.map.setView(t.marker.getLatLng())}),e.elements.lngInput.addEventListener("change",function(n){t.marker.setLatLng({lat:e.latitude,lng:Number(n.target.value)}),t.map.setView(t.marker.getLatLng())})))},Mapsel.api.Leaflet.prototype={center:function(e,t){this.map&&this.map.setView({lat:e,lng:t})}})}();